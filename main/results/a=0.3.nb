(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    697221,      19487]
NotebookOptionsPosition[    695154,      19455]
NotebookOutlinePosition[    695610,      19473]
CellTagsIndexPosition[    695567,      19470]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"0", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\n", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], "\n", 
  RowBox[{
  "(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], "\n", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 
   3.910190535022835*^9},ExpressionUUID->"42448357-8251-4341-9710-\
8625fa06c600"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"5", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\n", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], "\n", 
  RowBox[{
  "(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], "\n", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, {3.910108650800131*^9, 3.9101086744851713`*^9}, 
   3.910190535042839*^9},ExpressionUUID->"40a46fae-2fa8-4e51-90d0-\
e108e55dbe86"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"10", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.910108696695941*^9, 
   3.910108697666833*^9}, 
   3.910190535078848*^9},ExpressionUUID->"48a2f727-7f3f-48e2-be45-\
ce6792b46eef"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"15", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.9101087265458794`*^9, 
   3.9101087273168087`*^9}, 
   3.9101905351138554`*^9},ExpressionUUID->"7c76ce90-4874-4d97-b139-\
a5729867ad15"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"20", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 3.9101087427008815`*^9, 
   3.910190535147863*^9},ExpressionUUID->"a06fbf4d-71c2-45ef-a272-\
fc79fab588ed"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"25", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.910108758316745*^9, 
   3.9101087591679153`*^9}, 
   3.910190535182871*^9},ExpressionUUID->"dba47de3-53da-432d-ad47-\
072882d4e568"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"30", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 3.910108775356494*^9, 
   3.910190535217879*^9},ExpressionUUID->"8af1449e-1404-4b66-aeb4-\
47ec0de44f04"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"35", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.910108800299016*^9, 
   3.910108801100729*^9}, 
   3.9101905352798395`*^9},ExpressionUUID->"dd394052-611a-461b-a857-\
fd9d9a88fcae"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"40", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 3.9101088141228037`*^9, 
   3.9101905353143606`*^9},ExpressionUUID->"5f14570d-86e0-43cb-a965-\
a0c63710d42d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"45", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.9101088272365065`*^9, 
   3.9101088279319468`*^9}, 
   3.9101905353483677`*^9},ExpressionUUID->"138435a3-1da9-4e19-a065-\
d16ce1115198"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"50", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 3.910108844121883*^9, 
   3.9101905353833756`*^9},ExpressionUUID->"5692217c-8cf1-4c67-9ed8-\
612bc9116d6c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"55", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\n", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], "\n", 
  RowBox[{
  "(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], "\n", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.910108859408876*^9, 
   3.910108859531144*^9}, 
   3.910190535419384*^9},ExpressionUUID->"cc24d9fc-3b97-46e4-9e71-\
1007dfaeee25"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"60", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 3.910108872282872*^9, 
   3.9101905354543915`*^9},ExpressionUUID->"012aaaf6-bfd8-4bbb-96b1-\
b30fb1809f0d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"65", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.9101088883310556`*^9, 
   3.9101088890339513`*^9}, 
   3.9101905354904*^9},ExpressionUUID->"c395814c-36ae-4304-9eea-26b7c229d5e2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"70", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 3.9101089036362486`*^9, 
   3.9101905355254087`*^9},ExpressionUUID->"c15dfb40-7aaa-4cb3-915c-\
2d7fefc3b0d1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"75", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, {3.9101089220238523`*^9, 
   3.910108922719415*^9}, 
   3.9101905355604157`*^9},ExpressionUUID->"f4c78647-52ad-4bf3-94b5-\
1c39c9ee07af"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", "m", "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:53c2\:6570parameters", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a", "=", 
   RowBox[{"30", "/", "100"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Qm", "=", 
    RowBox[{"80", "/", "100"}]}], ";"}], "\n", 
  RowBox[{"(*", "\:5ea6\:89c4Metric", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"m", "[", "r_", "]"}], ":=", 
   RowBox[{"1", "-", 
    FractionBox[
     SuperscriptBox["Qm", "2"], 
     RowBox[{"2", "r"}]]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalSigma]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "+", 
    RowBox[{
     SuperscriptBox["a", "2"], 
     SuperscriptBox[
      RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{
    SuperscriptBox["r", "2"], "-", 
    RowBox[{"2", " ", 
     RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
    SuperscriptBox["a", "2"]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"g", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], ")"}], "/", 
            "\[CapitalSigma]"}]}], ")"}]}], ",", "0", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"\[CapitalSigma]", "/", "\[CapitalDelta]"}], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "\[CapitalSigma]", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}]}], "2", " ", "a", " ", 
         RowBox[{"m", "[", "r", "]"}], "r", " ", 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], ",", "0", ",", "0", 
        ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "\[CapitalSigma]"}], ")"}], "2", " ", 
            RowBox[{"m", "[", "r", "]"}], 
            SuperscriptBox["a", "2"], "r", " ", 
            SuperscriptBox[
             RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], "}"}]}], "}"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"g_", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ig", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        FractionBox[
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "+", 
               SuperscriptBox["r", "2"]}], ")"}], "2"], "-", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["a", "2"], "-", 
               RowBox[{"2", " ", 
                RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
               SuperscriptBox["r", "2"]}], ")"}], " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ")"}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}]}]], ",", "0", ",", "0", ",", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", 
        FractionBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["a", "2"], "-", 
           RowBox[{"2", " ", 
            RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
           SuperscriptBox["r", "2"]}], ")"}], 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0", ",", 
        "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", 
        FractionBox["1", 
         RowBox[{
          SuperscriptBox["r", "2"], "+", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]], ",", "0"}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r"}], 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["r", "2"], "+", 
             RowBox[{
              SuperscriptBox["a", "2"], " ", 
              SuperscriptBox[
               RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["a", "2"], "-", 
             RowBox[{"2", " ", 
              RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
             SuperscriptBox["r", "2"]}], ")"}]}]]}], ",", "0", ",", "0", ",", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], "-", 
          RowBox[{
           SuperscriptBox["a", "2"], " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["r", "2"], "+", 
            RowBox[{
             SuperscriptBox["a", "2"], " ", 
             SuperscriptBox[
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}], ")"}], 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["a", "2"], "-", 
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], "r"}], "+", 
            SuperscriptBox["r", "2"]}], ")"}], 
          SuperscriptBox[
           RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]]}], "}"}]}], "}"}]}],
    ";"}], 
  RowBox[{"(*", 
   RowBox[{"g", "^", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\\", "mu"}], "\\n", "u"}], "}"}]}], "*)"}], "\n", 
  RowBox[{
  "(*", "\:54c8\:5bc6\:987f\:91cfHamiltonian", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"QQ", "=", 
   RowBox[{"{", 
    RowBox[{"qt", ",", "qr", ",", "q\[Theta]", ",", "q\[Phi]"}], "}"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "=", 
    RowBox[{
     RowBox[{
      FractionBox["1", "2"], 
      RowBox[{"(", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Ig", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "i", "]"}], "]"}], 
          RowBox[{"QQ", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "4"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "4"}], "}"}]}], "]"}], ")"}]}], "//", 
     "Simplify"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8fd0\:52a8\:65b9\:7a0bEoM", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"du", "=", 
   RowBox[{"{", 
    RowBox[{
    "td", ",", "rd", ",", "\[Theta]d", ",", "\[Phi]d", ",", "qrd", ",", 
     "q\[Theta]d"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"td", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qt"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"rd", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "qr"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Theta]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Theta]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]d", "=", 
   RowBox[{"D", "[", 
    RowBox[{"H", ",", "q\[Phi]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qrd", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "r"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"q\[Theta]d", "=", 
   RowBox[{"-", 
    RowBox[{"D", "[", 
     RowBox[{"H", ",", "\[Theta]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Deom", "=", 
    RowBox[{"du", "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"qt", "\[Rule]", 
        RowBox[{"-", "EE"}]}], ",", 
       RowBox[{"q\[Phi]", "\[Rule]", " ", "LL"}], ",", 
       RowBox[{"t", "\[Rule]", " ", 
        RowBox[{"t", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"r", "\[Rule]", " ", 
        RowBox[{"r", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Theta]", "\[Rule]", " ", 
        RowBox[{"\[Theta]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"\[Phi]", "\[Rule]", " ", 
        RowBox[{"\[Phi]", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"qr", "\[Rule]", " ", 
        RowBox[{"qr", "[", "\[Lambda]", "]"}]}], ",", 
       RowBox[{"q\[Theta]", "\[Rule]", " ", 
        RowBox[{"q\[Theta]", "[", "\[Lambda]", "]"}]}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"\\", "delta"}], "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
1-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "\:5b9a\:4e49Kerr\:5ea6\:89c4", "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MetricDown", "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MetricDown", "[", 
     RowBox[{"{", 
      RowBox[{"t_", ",", "r_", ",", "\[Theta]_", ",", "\[Phi]_"}], "}"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tt", ",", "rr", ",", "\[Theta]\[Theta]", ",", "\[Phi]\[Phi]", ",", 
        "t\[Phi]", ",", "\[CapitalSigma]", ",", "\[CapitalDelta]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalSigma]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "+", 
         RowBox[{
          SuperscriptBox["a", "2"], 
          SuperscriptBox[
           RowBox[{"Cos", "[", "\[Theta]", "]"}], "2"]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[CapitalDelta]", "=", 
        RowBox[{
         SuperscriptBox["r", "2"], "-", 
         RowBox[{"2", 
          RowBox[{"m", "[", "r", "]"}], " ", "r"}], "+", 
         SuperscriptBox["a", "2"]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tt", "=", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"1", "-", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], " ", "r"}], "\[CapitalSigma]"]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rr", "=", 
        FractionBox["\[CapitalSigma]", "\[CapitalDelta]"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Theta]\[Theta]", "=", "\[CapitalSigma]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]\[Phi]", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["r", "2"], "+", 
           SuperscriptBox["a", "2"], "+", 
           FractionBox[
            RowBox[{"2", " ", 
             RowBox[{"m", "[", "r", "]"}], 
             SuperscriptBox["a", "2"], "r", " ", 
             SuperscriptBox[
              RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
            "\[CapitalSigma]"]}], ")"}], 
         SuperscriptBox[
          RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t\[Phi]", "=", 
        RowBox[{"-", 
         FractionBox[
          RowBox[{"2", " ", "a", " ", 
           RowBox[{"m", "[", "r", "]"}], "r", " ", 
           SuperscriptBox[
            RowBox[{"Sin", "[", "\[Theta]", "]"}], "2"]}], 
          "\[CapitalSigma]"]}]}], ";", "\[IndentingNewLine]", 
       TagBox[
        RowBox[{"(", "\[NoBreak]", GridBox[{
           {"tt", "0", "0", "t\[Phi]"},
           {"0", "rr", "0", "0"},
           {"0", "0", "\[Theta]\[Theta]", "0"},
           {"t\[Phi]", "0", "0", "\[Phi]\[Phi]"}
          },
          GridBoxAlignment->{"Columns" -> {{Center}}, "Rows" -> {{Baseline}}},
          GridBoxSpacings->{"Columns" -> {
              Offset[0.27999999999999997`], {
               Offset[0.7]}, 
              Offset[0.27999999999999997`]}, "Rows" -> {
              Offset[0.2], {
               Offset[0.4]}, 
              Offset[0.2]}}], "\[NoBreak]", ")"}],
        Function[BoxForm`e$, 
         MatrixForm[BoxForm`e$]]]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"\:628a\[Theta]\:53d8\:52300", "~", "\[Pi]"}], "\:ff0c", 
    RowBox[{
     RowBox[{"\:628a\[Psi]\:53d8\:52300", "~", "2"}], "\[Pi]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "WrapAngle", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapAngle", "[", 
     RowBox[{"a1_", ",", "a2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x1", "=", "a1"}], ",", 
        RowBox[{"x2", "=", "a2"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", ">", "\[Pi]"}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x1", "<", 
          RowBox[{"-", "\[Pi]"}]}], ",", 
         RowBox[{"x1", "=", 
          RowBox[{"x1", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x1", "<", "0"}], ",", 
         RowBox[{
          RowBox[{"x1", "=", 
           RowBox[{"-", "x1"}]}], ";", 
          RowBox[{"x2", "=", 
           RowBox[{"x2", "+", "\[Pi]"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "\[GreaterEqual]", 
          RowBox[{"2", "\[Pi]"}]}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "-", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"x2", "<", "0"}], ",", 
         RowBox[{"x2", "=", 
          RowBox[{"x2", "+", 
           RowBox[{"2", "\[Pi]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x1", ",", "x2"}], "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "ZAMO\:6807\:67b6\:573a", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "LocalTetrads", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LocalTetrads", "[", 
     RowBox[{"pos_", ",", "metric_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e0", ",", "e1", ",", "e2", ",", "e3", ",", "gtt", ",", "grr", ",", 
        "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", ",", "gt\[Phi]"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "gtt", ",", "grr", ",", "g\[Theta]\[Theta]", ",", "g\[Phi]\[Phi]", 
          ",", "gt\[Phi]"}], "}"}], "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"metric", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"4", ",", "4"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e0", "=", 
        RowBox[{
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"g\[Phi]\[Phi]", "/", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"gtt", " ", "g\[Phi]\[Phi]"}], "-", 
                RowBox[{"gt\[Phi]", " ", "gt\[Phi]"}]}], ")"}]}], ")"}]}], 
           ")"}]}], 
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0", ",", 
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{"gt\[Phi]", "/", "g\[Phi]\[Phi]"}], ")"}]}]}], "}"}]}]}],
        ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "t"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e1", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "grr"}], ")"}]}], ")"}]}], ",", "0", ",", 
          "0"}], "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "r"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e2", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sqrt]", "g\[Theta]\[Theta]"}], ")"}]}], ",", "0"}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        SubscriptBox["e", "\[Theta]"], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"e3", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0", ",", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", "g\[Phi]\[Phi]"}], ")"}]}], ")"}]}]}], 
         "}"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"-", 
         SubscriptBox["e", "\[Phi]"]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:5f97\:5230\:5149\:7ebf\:7684\:521d\:59cb\:65b9\:5411\:4ee5\:53ca\
\:76f8\:5bf9\:5e94\:7684\:4e0a\:6807\:56db\:901f\:5ea6", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetIniMomentum", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"GetIniMomentum", "[", 
      RowBox[{"metric_", ",", "pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "\[Lambda]dot", ",", "xscr", ",", "yscr", ",", "\[Theta]x", ",", 
        "\[Psi]x", ",", "vel", ",", "e0", ",", "e1", ",", "e2", ",", "e3", 
        ",", "momentum", ",", "IKn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xscr", ",", "yscr"}], "}"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tan", "[", 
               RowBox[{"fov", "/", "2"}], "]"}], "/", "npix"}]}], ")"}], 
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "/", "2"}], ")"}], 
              RowBox[{"(", 
               RowBox[{"npix", "+", "1"}], ")"}]}]}], ")"}]}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Theta]x", ",", "\[Psi]x"}], "}"}], "=", 
        RowBox[{"WrapAngle", "[", 
         RowBox[{
          RowBox[{"2", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"\[Sqrt]", 
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["xscr", "2"], "+", 
                 SuperscriptBox["yscr", "2"]}], ")"}]}], ")"}], "/", "2"}], 
            "]"}]}], ",", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"-", "yscr"}], ",", 
            RowBox[{"-", "xscr"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vel", "=", 
        RowBox[{"N", "@", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", "\[Theta]x", "]"}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Cos", "[", "\[Psi]x", "]"}]}], ",", 
           RowBox[{
            RowBox[{"Sin", "[", "\[Theta]x", "]"}], 
            RowBox[{"Sin", "[", "\[Psi]x", "]"}]}]}], "}"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e0", ",", "e1", ",", "e2", ",", "e3"}], "}"}], "=", 
        RowBox[{"N", "@", 
         RowBox[{"LocalTetrads", "[", 
          RowBox[{"pos", ",", "metric"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Lambda]dot", "=", 
        RowBox[{"e0", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "e1"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "e2"}], "+", 
           RowBox[{
            RowBox[{"vel", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "e3"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"momentum", "=", 
        RowBox[{"metric", ".", "\[Lambda]dot"}]}], ";", "\[IndentingNewLine]",
        "momentum"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:6570\:503c\:6c42\:89e3\:5355\:6761\:5149\:7ebf\:7684\:65b9\:7a0b", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceSingleRay", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TraceSingleRay", "[", 
     RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[Lambda]F", "=", "3000"}], ",", "eqns", ",", "E0", ",", "L0",
        ",", "idata", ",", "initialConditions", ",", "sol", ",", "frame", ",",
        "momentum", ",", "eom", ",", "data", ",", "tag", ",", "rF", ",", 
       "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momentum", "=", 
       RowBox[{
        RowBox[{"GetIniMomentum", "[", 
         RowBox[{
          RowBox[{"MetricDown", "[", "pos", "]"}], ",", "pos", ",", "fov", 
          ",", "npix"}], "]"}], "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"E0", ",", "L0"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"momentum", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"momentum", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idata", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"pos", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"momentum", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"momentum", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"initialConditions", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"t", "[", "0", "]"}], ",", 
           RowBox[{"r", "[", "0", "]"}], ",", 
           RowBox[{"\[Theta]", "[", "0", "]"}], ",", 
           RowBox[{"\[Phi]", "[", "0", "]"}], ",", 
           RowBox[{"qr", "[", "0", "]"}], ",", 
           RowBox[{"q\[Theta]", "[", "0", "]"}]}], "}"}], "==", "idata"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eom", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"r", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Theta]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"\[Phi]", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"qr", "'"}], "[", "\[Lambda]", "]"}], ",", 
           RowBox[{
            RowBox[{"q\[Theta]", "'"}], "[", "\[Lambda]", "]"}]}], "}"}], 
         "\[Equal]", "Deom"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"eqns", "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"eom", ",", "initialConditions"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EE", "\[Rule]", " ", "E0"}], ",", 
           RowBox[{"LL", "\[Rule]", " ", "L0"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"NDSolve", "[", 
        RowBox[{"eqns", ",", 
         RowBox[{"{", 
          RowBox[{
          "t", ",", "r", ",", "\[Theta]", ",", "\[Phi]", ",", "qr", ",", 
           "q\[Theta]"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]", ",", "0", ",", 
           RowBox[{"-", "\[Lambda]F"}]}], "}"}], ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<EventLocator\>\"", ",", " ", 
            RowBox[{"\"\<Event\>\"", "\[Rule]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"1.01", "horizon"}]}], ",", 
               RowBox[{
                RowBox[{"r", "[", "\[Lambda]", "]"}], "-", 
                RowBox[{"10000", "horizon"}]}]}], "}"}]}], ",", 
            RowBox[{"\"\<EventAction\>\"", "\[RuleDelayed]", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}], ",", 
               RowBox[{"Throw", "[", 
                RowBox[{
                 RowBox[{"\[Lambda]F", " ", "=", 
                  RowBox[{"-", "\[Lambda]"}]}], ",", 
                 "\"\<StopIntegration\>\""}], "]"}]}], "}"}]}]}], "}"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rF", "=", 
       RowBox[{
        RowBox[{"r", "[", 
         RowBox[{"-", "\[Lambda]F"}], "]"}], "/.", 
        RowBox[{"sol", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"r", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"\[Phi]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"qr", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", 
         RowBox[{"q\[Theta]", "[", 
          RowBox[{"-", "\[Lambda]F"}], "]"}], ",", "E0", ",", "L0"}], "}"}], "/.", 
       RowBox[{"sol", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:641e\:4e00\:4e2a\:8fdb\:5ea6\:6761\:67e5\:770b\:8dd1\:4e86\:591a\
\:5c11", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "MonitorParallelTable", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MonitorParallelTable", "[", 
     RowBox[{"expr_", ",", "npix_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"res", ",", 
        RowBox[{"iterCount", "=", 
         SuperscriptBox["npix", "2"]}], ",", 
        RowBox[{"progress", "=", "0"}]}], "}"}], ",", "\n", "  ", 
      RowBox[{
       RowBox[{"SetSharedVariable", "[", "progress", "]"}], ";", "\n", "  ", 
       RowBox[{"res", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"progress", "++"}], ";", 
              RowBox[{"expr", "[", 
               RowBox[{"j", ",", "i"}], "]"}]}], ")"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "npix"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "npix"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "i\:5bf9\:5e94\:884c", ",", 
            "\:753b\:56fe\:65f6\:662fy\:5750\:6807", ",", 
            "j\:5bf9\:5e94\:5217", ",", 
            "\:753b\:56fe\:65f6\:662fx\:5750\:6807", "\:3002", 
            "\:4f46\:662fTraceSingleRay\:7684\:53c2\:6570\:4e2d", ",", 
            "\:7b2c\:4e00\:4e2a\:5143\:7d20\:662fx\:5750\:6807", ",", 
            "\:7b2c\:4e8c\:4e2a\:5143\:7d20\:662fy\:5750\:6807", ",", 
            "\:6240\:4ee5\:770b\:8d77\:6765\:6709\:70b9\:5947\:602a"}], 
           "*)"}], "\n", "    ", 
          RowBox[{"Column", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "progress"}], "<>", "\"\< of \>\"", "<>", 
               RowBox[{"ToString", "@", "iterCount"}]}], ",", 
              RowBox[{"ProgressIndicator", "[", 
               RowBox[{"progress", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "iterCount"}], "}"}]}], "]"}]}], "}"}], 
            ",", 
            RowBox[{"Alignment", "\[Rule]", "Center"}]}], "]"}]}], "]"}]}], 
       ";", "\n", "  ", 
       RowBox[{"UnsetShared", "[", "progress", "]"}], ";", 
       "\[IndentingNewLine]", "res"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{
  "(*", "\:8dd1\:6240\:6709\:7684\:70b9", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "TraceRay", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos_", ",", "fov_", ",", "npix_"}], "]"}], ":=", 
   RowBox[{"MonitorParallelTable", "[", 
    RowBox[{
     RowBox[{"TraceSingleRay", "[", 
      RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}], ",", "npix"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<-------------------------------Done \
2-------------------------------------------\>\"", "]"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "\:51c6\:5907\:5c31\:7eea", "\:ff0c", "\:5f00\:59cb\:8dd1\:51fd\:6570"}], 
   "*)"}]}], "\n", 
 RowBox[{"ClearAll", "[", 
  RowBox[{"result", ",", "resultplot"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"horizon", "=", 
   RowBox[{"1", "+", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"1", "-", 
      RowBox[{"a", "^", "2"}], "-", 
      RowBox[{"Qm", "^", "2"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", "80", ",", 
     RowBox[{
      RowBox[{"\[Pi]", "/", "2"}], "-", "0.01"}], ",", "0"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"\[Pi]", "/", "5"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"npix", "=", "1024"}], ";", 
  RowBox[{"(*", 
   RowBox[{"should", " ", "be", " ", "even"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"result", "=", 
   RowBox[{"TraceRay", "[", 
    RowBox[{"pos", ",", "fov", ",", "npix"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"resultplot", "=", 
    RowBox[{"result", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "All", ",", 
       RowBox[{"1", ";;", "3"}]}], "]"}], "]"}]}], ";"}], "\n", 
  RowBox[{
  "(*", "\:9a8c\:8bc1\:4e00\:4e0b\:672b\:6001\:54c8\:5bc6\:987f\:91cf", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"icheck", "=", "100"}], ";", 
  RowBox[{"(*", 
   RowBox[{"\:68c0\:67e5\:70b9", 
    RowBox[{"(", 
     RowBox[{"icheck", ",", "icheck"}], ")"}], 
    "\:7684\:54c8\:5bc6\:987f\:91cf\:662f\:5426\:4e3a0"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"Print", "[", 
   RowBox[{"H", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"r", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "1"}], "]"}], "]"}]}], ",", 
      RowBox[{"\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{"qr", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "4"}], "]"}], "]"}]}], ",", 
      RowBox[{"q\[Theta]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "5"}], "]"}], "]"}]}], ",", 
      RowBox[{"qt", "\[Rule]", 
       RowBox[{"-", 
        RowBox[{"result", "[", 
         RowBox[{"[", 
          RowBox[{"icheck", ",", "icheck", ",", "6"}], "]"}], "]"}]}]}], ",", 
      RowBox[{"q\[Phi]", "\[Rule]", 
       RowBox[{"result", "[", 
        RowBox[{"[", 
         RowBox[{"icheck", ",", "icheck", ",", "7"}], "]"}], "]"}]}]}], 
     "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"split", "=", 
   RowBox[{"\[Pi]", "/", "18"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetColor", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ClearAll", "[", "GetClosestAngle", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"pos", "[", 
      RowBox[{"[", "3", "]"}], "]"}], ",", 
     RowBox[{"pos", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetClosestAngle", "[", "x_", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"q", "=", 
       RowBox[{"IntegerPart", "[", 
        RowBox[{"x", "/", "split"}], "]"}]}], "}"}], ",", 
     RowBox[{"Min", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"q", "+", "1"}], ")"}], "split"}], "-", "x"}], ",", 
       RowBox[{"x", "-", 
        RowBox[{"q", " ", "split"}]}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetColor", "[", 
    RowBox[{"{", 
     RowBox[{"rF_", ",", "\[Theta]Fx_", ",", "\[Phi]Fx_"}], "}"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rF", "<", 
         RowBox[{"3", " ", "horizon"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}]}], "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\:6b64\:5904\:539f\:672c\:662frF", "<", 
         RowBox[{"1.1", " ", "horizon0"}]}], ",", 
        "\:4f46\:597d\:50cf\:8fdd\:53cd\:8fd9\:4e2a\:6761\:4ef6\:4e0d\:8db3\
\:4ee5\:4fdd\:8bc1\:5149\:5b50\:53ef\:4ee5\:51fa\:5c04"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]F", ",", "\[Phi]F"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{"\[Theta]Fx", ",", "\[Phi]Fx"}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n1", ",", "n2"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", "\[Theta]0", "]"}]}], 
           RowBox[{"Sin", "[", "\[Theta]F", "]"}], " ", 
           RowBox[{"Cos", "[", 
            RowBox[{"\[Phi]F", "-", "\[Phi]0"}], "]"}]}], "+", 
          RowBox[{
           RowBox[{"Sin", "[", "\[Theta]0", "]"}], 
           RowBox[{"Cos", "[", "\[Theta]F", "]"}]}]}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"theta", ",", "psi"}], "}"}], "=", 
       RowBox[{"WrapAngle", "[", 
        RowBox[{
         RowBox[{"ArcSin", "[", "n2", "]"}], ",", 
         RowBox[{"ArcSin", "[", "n1", "]"}]}], "]"}]}], ";", 
      RowBox[{
      "(*", "\:6ce8\:610ftheta\:548cpsi\:90fd\:662f\:7eac\:7ebf", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "theta", "]"}], "\[LessEqual]", 
          "0.01"}], "||", 
         RowBox[{
          RowBox[{"GetClosestAngle", "[", "psi", "]"}], "\[LessEqual]", 
          "0.01"}]}], ",", 
        RowBox[{"Return", "[", "Black", "]"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"225", ",", "227", ",", "76"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "yellow", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", ">", "0"}], "&&", 
         RowBox[{"n2", "<", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"62", ",", "55", ",", "129"}], "}"}], "/", "255"}], "]"}], 
        RowBox[{"(*", "blue", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", "<", " ", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"240", ",", "138", ",", "122"}], "}"}], "/", "255"}], 
         "]"}], 
        RowBox[{"(*", "red", "*)"}], ",", 
        RowBox[{
         RowBox[{"n1", "<", "0"}], "&&", 
         RowBox[{"n2", ">", "0"}]}], ",", 
        RowBox[{"RGBColor", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"77", ",", "178", ",", "71"}], "}"}], "/", "255"}], 
         "]"}]}], 
       RowBox[{"(*", "green", "*)"}], "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MatrixPlot", "[", 
   RowBox[{
    RowBox[{"Map", "[", 
     RowBox[{"GetColor", ",", "resultplot", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], ",", 
    RowBox[{"DataReversed", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"True", ",", "False"}], "}"}]}], ",", 
    RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}], "\[IndentingNewLine]", 
  RowBox[{"(*", "\:753bShadow", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", 
  RowBox[{
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "<", 
         RowBox[{"3", "horizon"}]}], ",", "1", ",", "0"}], "]"}], "&"}], ",", 
     RowBox[{"resultplot", "\[LeftDoubleBracket]", 
      RowBox[{"All", ",", "All", ",", "1"}], "\[RightDoubleBracket]"}], ",", 
     RowBox[{"{", "2", "}"}]}], "]"}], ",", 
   RowBox[{"ColorFunction", "\[Rule]", "\"\<Monochrome\>\""}], ",", 
   RowBox[{"DataReversed", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"True", ",", "False"}], "}"}]}], ",", 
   RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.9073152279873457`*^9, 3.907315233201717*^9}, {
   3.907315331793416*^9, 3.90731535944871*^9}, {3.9101085722371154`*^9, 
   3.9101085840221386`*^9}, 3.910108650800131*^9, 3.9101089393785334`*^9, 
   3.9101905355954237`*^9},ExpressionUUID->"dd2224e4-04da-4a55-9bd5-\
d4a1d6dd8551"]
},
WindowSize->{1080., 632.5},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
TaggingRules-><|"TryRealOnly" -> False|>,
FrontEndVersion->"13.0 for Microsoft Windows (64-bit) (2021\:5e7412\:67082\
\:65e5)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"8254c0ea-5f3b-49a7-932d-06995fb589de"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 40815, 1140, 3663, "Input",ExpressionUUID->"42448357-8251-4341-9710-8625fa06c600"],
Cell[41376, 1162, 40841, 1140, 3663, "Input",ExpressionUUID->"40a46fae-2fa8-4e51-90d0-e108e55dbe86"],
Cell[82220, 2304, 40870, 1142, 3663, "Input",ExpressionUUID->"48a2f727-7f3f-48e2-be45-ce6792b46eef"],
Cell[123093, 3448, 40876, 1142, 3663, "Input",ExpressionUUID->"7c76ce90-4874-4d97-b139-a5729867ad15"],
Cell[163972, 4592, 40844, 1141, 3663, "Input",ExpressionUUID->"a06fbf4d-71c2-45ef-a272-fc79fab588ed"],
Cell[204819, 5735, 40872, 1142, 3663, "Input",ExpressionUUID->"dba47de3-53da-432d-ad47-072882d4e568"],
Cell[245694, 6879, 40842, 1141, 3663, "Input",ExpressionUUID->"8af1449e-1404-4b66-aeb4-47ec0de44f04"],
Cell[286539, 8022, 40872, 1142, 3663, "Input",ExpressionUUID->"dd394052-611a-461b-a857-fd9d9a88fcae"],
Cell[327414, 9166, 40846, 1141, 3663, "Input",ExpressionUUID->"5f14570d-86e0-43cb-a965-a0c63710d42d"],
Cell[368263, 10309, 40876, 1142, 3663, "Input",ExpressionUUID->"138435a3-1da9-4e19-a065-d16ce1115198"],
Cell[409142, 11453, 40844, 1141, 3663, "Input",ExpressionUUID->"5692217c-8cf1-4c67-9ed8-612bc9116d6c"],
Cell[449989, 12596, 40866, 1141, 3663, "Input",ExpressionUUID->"cc24d9fc-3b97-46e4-9e71-1007dfaeee25"],
Cell[490858, 13739, 40844, 1141, 3663, "Input",ExpressionUUID->"012aaaf6-bfd8-4bbb-96b1-b30fb1809f0d"],
Cell[531705, 14882, 40870, 1141, 3663, "Input",ExpressionUUID->"c395814c-36ae-4304-9eea-26b7c229d5e2"],
Cell[572578, 16025, 40846, 1141, 3663, "Input",ExpressionUUID->"c15dfb40-7aaa-4cb3-915c-2d7fefc3b0d1"],
Cell[613427, 17168, 40874, 1142, 3663, "Input",ExpressionUUID->"f4c78647-52ad-4bf3-94b5-1c39c9ee07af"],
Cell[654304, 18312, 40846, 1141, 3663, "Input",ExpressionUUID->"dd2224e4-04da-4a55-9bd5-d4a1d6dd8551"]
}
]
*)

